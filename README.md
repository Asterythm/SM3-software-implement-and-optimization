# SM3-software-implement-and-optimization
Project 4: SM3的软件实现与优化  a）：与Project 1类似，从SM3的基本软件实现出发，参考付勇老师的PPT，不断对SM3的软件执行效率进行改进 b）：基于sm3的实现，验证length-extension attack c）：基于sm3的实现，根据RFC6962构建Merkle树（10w叶子节点），并构建叶子的存在性证明和不存在性证明
# SM3软件实现与优化

## 算法概述

SM3算法是中国国家密码管理局发布的密码杂凑算法，广泛应用于数据完整性验证和数字签名，基于Merkle-Damgård结构，其核心包括消息扩展和压缩函数两个阶段。本文档重点介绍如何通过ARM64和x86-64架构的特定指令集优化SM3算法的性能，特别是在消息扩展阶段减少计算开销，提高处理效率。

## ARM64架构优化

### 核心指令：rev32

在ARM64架构（包括ARMv8和ARMv9）上，`rev32`指令用于高效的32位字节序反转操作，特别适合SM3算法的消息扩展阶段。

- **功能**：`rev32`将32位寄存器中的字节序反转，优化位操作的执行效率。
- **应用场景**：在消息扩展中，`rev32`用于快速处理输入数据的位旋转和异或操作，减少指令周期。
- **代码示例**：
	```arm
	rev32 v0.4s, v1.4s  // 反转32位向量寄存器v1中的字节序，存入v0
	eor v2.4s, v0.4s, v3.4s  // 对结果进行异或操作
	```

### 优化效果

通过使用`rev32`和向量指令，ARM64实现的消息扩展显著减少了循环中的指令数。测试表明，优化后的SM3算法在ARMv9架构上的执行时间可减少约30%。

## x86-64架构优化

### 核心指令集：AVX512

在x86-64架构上，AVX512指令集提供了强大的并行处理能力，特别适合SM3算法的消息扩展和压缩函数。以下是关键指令的使用方式：

- **指令：`vpxorq` 和 `vprold`**：
	- `vpxorq`：执行512位向量的按位异或操作，用于消息扩展中的逻辑运算。
	- `vprold`：执行向量化的32位左旋转操作，支持SM3算法中的`ROTL32`运算。
- **应用场景**：AVX512指令允许同时处理多个消息块，显著提升吞吐量。例如，在消息扩展中，`xmm`寄存器可并行处理多个32位字。
- **代码示例**：
	```x86
	vpxorq zmm0, zmm1, zmm2  ; 对zmm1和zmm2执行512位异或，存入zmm0
	vprold zmm0, zmm0, 15     ; 对zmm0执行32位左旋转15位
	```

### 消息扩展公式

SM3算法的消息扩展涉及以下关键公式：

1. \( W_{n} = P(HW_{n} \oplus W_{n} \cdot \text{ROTL32}(W_{n}, 15)) \oplus \text{ROTL32}(W_{n}, 7) \oplus W_{n} \)
2. \( P(I_{n}) = \text{ROTL32}(I_{n}, 15) \oplus \text{ROTL32}(I_{n}, 23) \)

在AVX512实现中，上述公式通过`vprold`和`vpxorq`指令并行化处理，显著降低计算延迟。

### 优化效果

AVX512指令的使用使SM3算法在x86-64架构上的性能提升了约2倍，尤其在处理大块数据时表现出色。并行处理能力减少了循环迭代次数，提升了整体吞吐量。

## 挑战与解决方案

- **指令集兼容性**：
	- **挑战**：ARMv8和ARMv9的指令集差异，以及x86-64中AVX512的硬件支持限制。
	- **解决方案**：通过条件编译生成架构特定的代码，确保兼容性。
- **内存对齐**：
	- **挑战**：AVX512指令对内存对齐要求较高，未对齐可能导致性能下降。
	- **解决方案**：优化数据结构，确保输入数据满足512位对齐要求。

